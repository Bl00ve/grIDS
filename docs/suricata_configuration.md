# Suricata Configuration
Suricata is an open source network intrusion detection/prevention software. You can learn more about it [here](https://suricata-ids.org/). We'll feed Suricata our network traffic, Suricata will run it through the ruleset we've configured and then will send alerts and logs to our Elastic stack for investigation.

My example Suricata configuration file [can be found here](../configs/suricata.yaml). I highly suggest referencing this file if Suricata fails to start.

## Installing Suricata
We're going to use the PPA provided by OSIF to make our updating a little bit easier. More information about OSIF can be found [HERE](https://redmine.openinfosecfoundation.org/projects/suricata/wiki/Ubuntu_Installation_-_Personal_Package_Archives_(PPA))

When we install Suricata this way, it also downloads the latest EmergingThreats IDS ruleset. We'll talk more about rules and configuration a bit later.

```
sudo add-apt-repository ppa:oisf/suricata-stable
sudo apt-get update
sudo apt-get install suricata
```

## Configuring Suricata

Useful Reference: [Suricata Documentation](http://suricata.readthedocs.io/en/latest/)

First we need to stop the process that started when we installed Suricata with the PPA, but enable the service to start on boot.
```
systemctl stop suricata
systemctl enable suricata
```

Next we'll work on getting through the important bits of the Suricata config file. There are hundreds of lines, and many tweaks you can do to improve performance and enable features, but we'll focus on the basics. As we make changes to the configuration, we'll be launching Suricata on the command line to ensure everything is working.

The Suricata config can be found at : `/etc/suricata/suricata.yaml`

### Step 1: HOME_NET and EXTERNAL_NET address-groups
Each rule written for Suricata has a direction of traffic flow that it's looking for. The setting list `HOME_NET` is considered the local network that you're monitoring. `EXTERNAL_NET` is the outside networks that you're monitoring traffic from.

It is important to get these settings right, as it impacts how the rules are interpreted. Incorrect address-groups can lead to both false positives and false negatives. In larger networks, this could also lead to a LOT of alerts that are garbage. Other than `HOME_NET` and `EXTERNAL_NET` you also need to evaluate each of the other address groups (eg: `HTTP_SERVERS`). You don't want HTTP alerts for non-HTTP servers.

For example settings, my `HOME_NET` is going to be configured as ` HOME_NET: "[192.168.1.0/24]"` since I have a small homelab network on that IP space. For `EXTERNAL_NET`, my network is configured as `EXTERNAL_NET: "!$HOME_NET"` which is shorthand for everything else that isn't inside `HOME_NET`.

### Step 2: Suricata Rules
Again, rules are the lifeblood of Suricata. We're going to be leveraging a tool called `PulledPork` for our rule management, so we'll come back to this section in a later document.

### Step 3: Outputs
Outputs are how we get data out of Suricata and into different systems. There will be a few different outputs that we'll concern ourselves with.

#### stats
Statistics for the Suricata process with things like flow count, uptime, etc. Useful and doesn't take up much space, so leave it enabled.

#### fast
A line based log, sends output to the file `/var/log/suricata/fast.log` by default in our install. It's useful for debug purposes, but since we'll be shipping all of our data to Elastic, it's not needed so set `enabled: no`

#### eve-log
Extensible Event Format (nicknamed EVE) is a JOSN format log that contains many different subsets of information. This is the log we'll be leveraging to ship off to Elastic. It's important to leave this enabled.

First, add a setting to rotate the eve.json file every time suricata is restarted (called `append: no`):
```
filename: eve.json
append: no
```

Below are each of the output types that eve.json will ship.

##### alert
These are the IDS alerts that are generated by Suricata when a rule is triggered. We want this in eve.json. 

We also want to enable the following fields in addition to the ones already enabled:
* `payload: yes` - payload will give us a Base64 encoded payload of what triggered the alert, which can then be decoded via Kibana.
* `http-body: yes` - the body of an http request, if applicable, encoded in Base64

##### http
Logging of all HTTP requests. Useful for data enrichment and historical analysis. Leave the fields configured as-is.

##### dns
Logging of all DNS requests. Useful for data enrichment, as well as historical context around strange DNS queries. Will also allow for tracking the most and least commonly resolved DNS names. Leave the fields configured as-is.

##### tls
TLS session tracking. Without breaking SSL, we can still obtain useful information about certificates passing over the wire. Leave the fields configured as-is.

##### files
File tracking. Useful for historical context around file downloads, as well as searching for IoCs in file hashes.

We also want to include additonal hashes, for better visibility:
* `force-hash: [md5, sha1, sha256]`

##### smtp
Since I don't have an SMTP server on my network, I'll be disabling this setting by commenting out `-smtp`, but determine if this is something you might need on your network.

##### ssh
SSH logging is quite verbose, and it's not something that I leverage that often, so I will be commenting out `-ssh`, but determine if this is something you might need on your network.

##### stats
I don't think that pushing stats to our Elastic setup is valuable, so I will be commenting out `-stats` and the lines below it.

##### flow
Netflow logging is quite helpful for many different segments of an investigation. Consider it network metadata of all connections on the network. Leave it enabled.

#### Unified2-alert
Since we're not leveraging Barnyard2, we don't need this.

#### http-log, tls-log, tls-store, dns-log
These connections are already being shipped to Elastic via eve.json, so this isn't needed. Leave them set to `enabled: no`

#### pcap-log
Network traffic captures (PCAP files) are important to have, but they're a beast of their own, so we'll cover packet captures in another section.

The remaining output settings can be left as is, but I recommend reading them to understand what might be applicable for your network. The inline documentation is quite verbose and useful.

### Step 4: configure common capture settings

#### af-packet
This is the standard capture library, and the one we'll be using. Set the `interface` setting to the network interface you set up as the monitoring interface earlier.

#### pcap
This is the standard pcap library, and the one we'll be using. Set the `interface` setting to the network interface you set up as the monitoring interface earlier.

### Remaining Configuration
The remaining configuration for Suricata is focused mainly around performance tuning and monitoring tweaks, so the defaults are safe for most users. In the future, I believe a tuning guide might be of value for higher throughput networks.

#### VLAN Configuration
If you're only seeing partial traffic (seeing DNS and netflow, but not seeing HTTP and other traffic), you might have to disable vlan tagging. Search for `vlan` and change the setting `use-for-tracking: false`

### Testing Suricata Configuration
Now that configuration is complete, we'll want to test our install from the command line, with more verbose options, to see where anything has failed.

First, double check that the service for Suricata is not running:
```
systemctl status suricata
```

Then, run Suricata from the command line with this command, and check for errors, as well as large percentages of packet drops:
```
suricata -vvvc /etc/suricata/suricata.yaml -i enp8s0
```

You should see output, and then a line ending with something like:
```
30/7/2017 -- 15:52:17 - <Notice> - all 4 packet processing threads, 4 management threads initialized, engine started.
30/7/2017 -- 15:52:17 - <Perf> - AF_PACKET RX Ring params: block_size=32768 block_nr=26 frame_size=1600 frame_nr=520
30/7/2017 -- 15:52:17 - <Perf> - AF_PACKET RX Ring params: block_size=32768 block_nr=26 frame_size=1600 frame_nr=520
30/7/2017 -- 15:52:17 - <Perf> - AF_PACKET RX Ring params: block_size=32768 block_nr=26 frame_size=1600 frame_nr=520
30/7/2017 -- 15:52:17 - <Perf> - AF_PACKET RX Ring params: block_size=32768 block_nr=26 frame_size=1600 frame_nr=520
30/7/2017 -- 15:52:17 - <Info> - All AFP capture threads are running.
```

Let this run for about a minute, then ctrl-c the command to see what the reported packet drop was.

### Starting Suricata
Now that we know our Suricata configuration is working, we can start it as a service:

```
systemctl start suricata
```
